<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.fitsync.mapper.ReviewMapper">
	<resultMap id="ReviewResultMap" type="org.fitsync.domain.ReviewVO">
    <result property="matching_idx" column="matching_idx" />
    <result property="review_star" column="review_star" />
    <result property="member_idx" column="member_idx" />
    <result property="review_title" column="review_title" />
    <result property="review_content" column="review_content" />
    <result property="review_hidden" column="review_hidden" />
    <result property="member_name" column="member_name" />
    <result property="member_image" column="member_image" />
	</resultMap>
	
	
	<select id="getReview" parameterType="int">
		SELECT * FROM REVIEW WHERE MEMBER_IDX = #{member_idx}
	</select>
	
	<select id="getReviewOne" parameterType="int" resultType="org.fitsync.domain.ReviewVO">
		SELECT * 
		FROM REVIEW 
		WHERE MATCHING_IDX = #{matching_idx}
	</select>
	
  	<!-- 1. 리뷰 목록 조회 -->
	<select id="selectReviewsByTrainer" resultMap="ReviewResultMap">
	  SELECT
	    r.matching_idx,
	    r.review_star,
	    r.member_idx,
	    r.review_title,
	    r.review_content,
	    r.review_hidden,
	    COALESCE(mem.member_name, '알 수 없음') AS member_name,
	    COALESCE(mem.member_image, '') AS member_image
	  FROM
	    review r
	  JOIN
	    matching m ON r.matching_idx = m.matching_idx
	  LEFT JOIN
	    member mem ON r.member_idx = mem.member_idx
	  WHERE
	    m.trainer_idx = #{trainerIdx}
	    AND (r.review_hidden = 'N' OR r.review_hidden IS NULL)
	  ORDER BY
	    r.review_star DESC
  	</select>
  	<insert id="insertReview">
	    INSERT INTO review (
	        REVIEW_STAR,
	        REVIEW_TITLE,
	        REVIEW_CONTENT,
	        MATCHING_IDX,
	        MEMBER_IDX,
	        REVIEW_HIDDEN
	    )
	    VALUES (
	        #{review_star},
	        #{review_title},
	        #{review_content},
	        #{matching_idx},
	        #{member_idx},
	        'N'
	    )
	</insert>

	
	<update id="reviewHidden" parameterType="int">
		UPDATE REVIEW 
		SET REVIEW_HIDDEN = 'Y'
		WHERE MATCHING_IDX = #{matching_idx}
	</update>
</mapper>